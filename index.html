<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>White Rabbit: Social Sprint - Level 4</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #2d1b4e;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <!-- Phaser 3 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    
    <script>
        // Debug mode - nastavte na true pro zobrazení frame rámečků
        const DEBUG_MODE = true;
        
        class Level4Scene extends Phaser.Scene {
            constructor() {
                super({ key: 'Level4Scene' });
                this.player = null;
                this.background = null;
                this.ground = null;
                this.bonusGroup = null;
                this.healthIcons = [];
                this.bgMusic = null;
                this.cursors = null;
                this.jumpCount = 0;
                this.maxJumps = 2; // Double jump
                this.bgScrollSpeed = 3;
                this.gameOver = false;
            }
            
            preload() {
                // Načtení assetů - dlouhý seamless background
                this.load.image('bg_background', 'bg_game.png');
                this.load.image('bg_foreground', 'bg_level4_foreground.png');
                this.load.image('bonus_heart', 'heart.png');
                this.load.image('bonus_like', 'like.png');
                this.load.image('health_icon', 'health.png');
                this.load.audio('bg_music', 'music.mp3');
                
                // Nový spritesheet 6×6 grid (3072×3072px)
                // Každý frame: 512×512px - pravidelný grid!
                this.load.spritesheet('rabbit', 'rabbit_spritesheet.png', {
                    frameWidth: 512,
                    frameHeight: 512,
                    margin: 0,
                    spacing: 0
                });
            }
            
            create() {
                const { width, height } = this.scale;
                
                // Background layer - 1:1 bez škálování (1201×529)
                this.background = this.add.tileSprite(width / 2, height / 2, width, height, 'bg_background');
                
                // Arcade Physics
                this.physics.world.gravity.y = 800;
                
                // Podlaha NÍŽE - blíž ke spodnímu okraji
                const groundY = 470;
                
                // Vytvoření podlahy
                this.ground = this.add.rectangle(width / 2, groundY, width * 2, 20, 0xff0000, 0);
                this.physics.add.existing(this.ground, true);
                this.ground.body.setSize(width * 2, 20);
                
                // Debug zobrazení podlahy
                if (DEBUG_MODE) {
                    this.ground.setFillStyle(0xff0000, 0.3);
                }
                
                // Hráč - níže, aby stál na nové podlaze
                const playerScale = 0.75;
                
                // Umístíme ho nad podlahu
                this.player = this.physics.add.sprite(width / 2, 330, 'rabbit');
                this.player.setCollideWorldBounds(false);
                this.player.setScale(playerScale);
                
                // Hitbox - ŽÁDNÝ offset, jen zmenšíme
                // Phaser automaticky vycentruje hitbox
                this.player.body.setSize(250, 300); // Větší hitbox, bez offsetu
                
                // Debug rámečky
                if (DEBUG_MODE) {
                    this.player.setDebug(true, true, 0x00ff00);
                }
                
                // Kolize s podlahou
                this.physics.add.collider(this.player, this.ground, () => {
                    this.jumpCount = 0; // Reset skoků při dotyku se zemí
                });

                // Bonusy (heart, like) - musí se vyskočit/dvojskok
                this.createBonuses();

                // UI indikátor životů (statický, bez logiky)
                this.createHealthUI();
                
                // Animace
                this.createAnimations();
                
                // Spuštění běhací animace
                this.player.anims.play('run', true);

                // Hudba na pozadí (loop)
                this.bgMusic = this.sound.add('bg_music', { loop: true, volume: 0.5 });
                this.bgMusic.play();
                
                // Foreground layer - 1:1 jako background, PŘES vše
                this.foreground = this.add.tileSprite(width / 2, height / 2, width, height, 'bg_foreground');
                this.foreground.setDepth(100); // Nad hráčem
                
                // Ovládání - Desktop
                this.cursors = this.input.keyboard.createCursorKeys();
                this.spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                
                // Ovládání - Mobile (tap)
                this.input.on('pointerdown', () => {
                    this.jump();
                });
                
                // FPS debug text (volitelné)
                if (DEBUG_MODE) {
                    this.debugText = this.add.text(10, 10, '', {
                        fontSize: '16px',
                        color: '#00ff00',
                        backgroundColor: '#000000'
                    });
                }
            }
            
            createAnimations() {
                // Frame indexy podle uživatele (ale od 0):
                // Idle: 1-6 → frames 0-5
                // Jump: 13-21 → frames 12-20
                // Run: 25-36 → frames 24-35
                
                // Idle - stojí
                this.anims.create({
                    key: 'idle',
                    frames: this.anims.generateFrameNumbers('rabbit', { 
                        start: 0, 
                        end: 5 
                    }),
                    frameRate: 8,
                    repeat: -1
                });
                
                // Jump - skok (9 framů)
                this.anims.create({
                    key: 'jump',
                    frames: this.anims.generateFrameNumbers('rabbit', { 
                        start: 12, 
                        end: 20 
                    }),
                    frameRate: 12,
                    repeat: 0
                });
                
                // Run - běh (12 framů)
                this.anims.create({
                    key: 'run',
                    frames: this.anims.generateFrameNumbers('rabbit', { 
                        start: 24, 
                        end: 35 
                    }),
                    frameRate: 20, // Rychlejší pro plynulý běh
                    repeat: -1
                });
                
                // Crash - použijeme poslední framy běhu
                this.anims.create({
                    key: 'crash',
                    frames: this.anims.generateFrameNumbers('rabbit', { 
                        start: 33, 
                        end: 35 
                    }),
                    frameRate: 8,
                    repeat: 0
                });
            }
            
            jump() {
                if (this.gameOver) return;
                
                // Kontrola double jump
                if (this.jumpCount < this.maxJumps) {
                    this.player.setVelocityY(-400);
                    this.jumpCount++;
                    
                    // Přehrání jump animace
                    if (this.player.anims.currentAnim.key !== 'jump') {
                        this.player.anims.play('jump', true);
                    }
                }
            }
            
            update(time, delta) {
                if (this.gameOver) return;
                
                // Scrollování pozadí a foreground (delta-based pro konzistentní rychlost)
                const scrollStep = (delta / 16.67) * this.bgScrollSpeed;
                this.background.tilePositionX += scrollStep * 0.5; // Background pomalu
                this.foreground.tilePositionX += scrollStep * 0.7; // Foreground o trochu rychleji

                // Pohyb bonusů (simulace scrollu) + recyklace
                this.updateBonuses();
                
                // Ovládání skoků
                if (Phaser.Input.Keyboard.JustDown(this.cursors.up) || 
                    Phaser.Input.Keyboard.JustDown(this.spaceKey)) {
                    this.jump();
                }
                
                // Animace podle stavu
                if (this.player.body.touching.down) {
                    // Na zemi - běží
                    if (this.player.anims.currentAnim.key !== 'run') {
                        this.player.anims.play('run', true);
                    }
                } else {
                    // Ve vzduchu - jump animace
                    if (this.player.anims.currentAnim.key !== 'jump') {
                        this.player.anims.play('jump', true);
                    }
                }
                
                // Debug info
                if (DEBUG_MODE && this.debugText) {
                    const fps = Math.round(this.game.loop.actualFps);
                    this.debugText.setText([
                        `FPS: ${fps}`,
                        `Player Y: ${Math.round(this.player.y)}`,
                        `Velocity Y: ${Math.round(this.player.body.velocity.y)}`,
                        `Jump Count: ${this.jumpCount}`,
                        `On Ground: ${this.player.body.touching.down}`,
                        `Current Anim: ${this.player.anims.currentAnim ? this.player.anims.currentAnim.key : 'none'}`,
                        `Frame: ${this.player.anims.currentFrame ? this.player.anims.currentFrame.index : 'none'}`
                    ]);
                }
                
                // Detekce pádu mimo obrazovku - jen pokud spadne HODNĚ dole
                if (this.player.y > this.scale.height + 300) {
                    this.triggerGameOver();
                }
            }

            createBonuses() {
                const { width } = this.scale;
                const baseSpeed = this.bgScrollSpeed * 30; // párujeme s vizuálním scrollováním
                const bonusConfigs = [
                    { key: 'bonus_heart', x: width * 0.9, y: 210, scale: 1.0 },
                    { key: 'bonus_like',  x: width * 1.2, y: 170, scale: 1.0 }
                ];

                // Bonusy bez gravitace
                this.bonusGroup = this.physics.add.group({
                    allowGravity: false,
                    immovable: true
                });
                bonusConfigs.forEach(cfg => {
                    const bonus = this.bonusGroup.create(cfg.x, cfg.y, cfg.key);
                    bonus.setScale(cfg.scale);
                    bonus.setOrigin(0.5, 0.5);
                    bonus.body.setAllowGravity(false);
                    bonus.body.setVelocityX(-baseSpeed);
                    bonus.body.setCollideWorldBounds(false);
                    bonus.body.allowRotation = false;
                });

                // Overlap sebere bonus a hned ho přesune vpravo
                this.physics.add.overlap(this.player, this.bonusGroup, (player, bonus) => {
                    this.recycleBonus(bonus);
                });
            }

            updateBonuses() {
                const { width } = this.scale;
                const baseSpeed = this.bgScrollSpeed * 30;
                this.bonusGroup.children.each(bonus => {
                    // udržuj rychlost synchronizovanou s bgScrollSpeed
                    bonus.body.setVelocityX(-baseSpeed);
                    bonus.body.setVelocityY(0);
                    // pokud odjede vlevo, recykluj vpravo
                    if (bonus.x < -50) {
                        this.recycleBonus(bonus);
                    }
                }, this);
            }

            recycleBonus(bonus) {
                const { width } = this.scale;
                const offset = Phaser.Math.Between(200, 400);
                bonus.x = width + offset;
                // náhodná výška, aby musel skákat / dvojskok
                bonus.y = Phaser.Math.Between(140, 230);
                bonus.body.setVelocityY(0);
            }

            createHealthUI() {
                const { width } = this.scale;
                const top = 20;
                const size = 40;
                const spacing = 10;
                this.healthIcons = [];
                for (let i = 0; i < 3; i++) {
                    const icon = this.add.image(width - (size + spacing) * (3 - i) + spacing, top + size / 2, 'health_icon');
                    icon.setOrigin(0.5, 0.5);
                    icon.setDisplaySize(size, size);
                    icon.setScrollFactor(0); // UI fixní k obrazovce
                    this.healthIcons.push(icon);
                }
            }
            
            triggerGameOver() {
                if (this.gameOver) return;
                
                this.gameOver = true;
                this.player.anims.play('crash', true);
                
                // Zobrazení Game Over textu
                const { width, height } = this.scale;
                const gameOverText = this.add.text(width / 2, height / 2, 'GAME OVER', {
                    fontSize: '64px',
                    color: '#ff0000',
                    fontStyle: 'bold',
                    stroke: '#000000',
                    strokeThickness: 6
                });
                gameOverText.setOrigin(0.5);
                
                const restartText = this.add.text(width / 2, height / 2 + 80, 'Tap or Press SPACE to Restart', {
                    fontSize: '24px',
                    color: '#ffffff',
                    stroke: '#000000',
                    strokeThickness: 4
                });
                restartText.setOrigin(0.5);
                
                // Restart po 2 sekundách
                this.time.delayedCall(2000, () => {
                    this.input.once('pointerdown', () => this.scene.restart());
                    this.input.keyboard.once('keydown-SPACE', () => this.scene.restart());
                });
            }
        }
        
        // Konfigurace Phaser hry
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            scale: {
                mode: Phaser.Scale.NONE, // Žádné škálování - vždy 1:1
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: 1201,  // Přesné rozměry 1:1
                height: 529
            },
            backgroundColor: '#000000', // Černý prostor kolem
            pixelArt: true,
            antialias: false,
            roundPixels: true,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: DEBUG_MODE
                }
            },
            scene: [Level4Scene]
        };
        
        // Spuštění hry
        const game = new Phaser.Game(config);
        
        // Prevence scrollování na mobile při swipe
        document.body.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>

